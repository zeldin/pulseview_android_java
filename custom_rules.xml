<?xml version="1.0" encoding="UTF-8"?>
<project>

  <property name="pulseview-source-path" value="${basedir}/.."/>
  <property name="pulseview-build-path" value="${pulseview-source-path}"/>
  <property name="cmake-cache" value="${pulseview-build-path}/CMakeCache.txt"/>

  <target name="-build-anttasks" >
    <mkdir dir="ant/build"/>
    <javac srcdir="ant/source" destdir="ant/build" includeantruntime="yes"/>
    <jar destfile="ant/tasks.jar">
      <fileset dir="ant/build" />
      <fileset dir="ant/resources"/>
    </jar>
  </target>

  <target name="-declare-anttasks" depends="-build-anttasks">
    <taskdef resource="anttasks.properties" classpath="ant/tasks.jar"/>
  </target>

  <target name="-get-prefix">
    <loadproperties srcFile="${cmake-cache}" prefix="cmake">
      <filterchain>
	<replaceregex pattern=":[A-Z]*=" replace="=" />
      </filterchain>
    </loadproperties>
    <property name="prefix" value="${cmake.CMAKE_INSTALL_PREFIX}"/>
  </target>

  <target name="-pre-build" depends="-get-prefix, -declare-anttasks">
    <copylibs todir="${native.libs.absolute.dir}" property="bundled_libs">
      <fileset dir="${pulseview-build-path}/libs" />
      <include name="libgnustl_shared.so"/>
      <exclude name="lib*.so"/>
    </copylibs>
    <copy file="bundled_libs.xml.in"
          tofile="${resource.absolute.dir}/values/bundled_libs.xml">
      <filterset>
        <filter token="bundled_libs" value="${bundled_libs}"/>
      </filterset>
    </copy>
    <copy file="${pulseview-source-path}/icons/sigrok-logo-notext.png"
          tofile="${resource.absolute.dir}/drawable/logo.png" />
    <copy todir="${asset.absolute.dir}/libsigrokdecode">
      <fileset dir="${prefix}/share/libsigrokdecode" />
    </copy>
    <copy todir="${asset.absolute.dir}/python3.3">
      <fileset dir="${prefix}/lib/python3.3">
	<include name="**/*.py"/>
      </fileset>
    </copy>
  </target>
</project>
